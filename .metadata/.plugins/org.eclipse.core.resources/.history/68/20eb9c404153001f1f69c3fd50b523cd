package com.monocept.app.service;

import java.util.ArrayList;
import java.util.List;

import org.springframework.stereotype.Service;

import com.monocept.app.Dto.CourseResponseDTO;
import com.monocept.app.Dto.StudentResponseDTO;
import com.monocept.app.entity.Course;
import com.monocept.app.entity.Student;
import com.monocept.app.repository.CourseRepository;
import com.monocept.app.repository.StudentRepository;

import jakarta.validation.Valid;



@Service
public class StudentCourseServiceImpl implements StudentCourseService{
	private StudentRepository studentRepository;
	private CourseRepository courseRepository;
	
	
	public StudentCourseServiceImpl(StudentRepository studentRepository, CourseRepository courseRepository) {
		super();
		this.studentRepository = studentRepository;
		this.courseRepository = courseRepository;
	}


	@Override
	public StudentResponseDTO addStudent(@Valid Student student) {
		return convertStudentToStudentResponseDTO(studentRepository.save(student));

	}


	private StudentResponseDTO convertStudentToStudentResponseDTO(Student student) {
		
		StudentResponseDTO studentDTO = new StudentResponseDTO();
        studentDTO.setId(student.getId());
        studentDTO.setStudentName(student.getName());
        
        List<CourseResponseDTO> courses = new ArrayList<>();
        for (Course c : student.getCourses()) {
            CourseResponseDTO courseDTO = new CourseResponseDTO();
            courseDTO.setId(c.getId());
            courseDTO.setTitle(c.getTitle());
            courses.add(courseDTO);
        }
        studentDTO.setCourses(courses);
		return studentDTO;
	}


	


	@Override
	public List<StudentResponseDTO> getStudents() {
	
		List<Student> students = studentRepository.findAll();

		return convertStudentToStudentResponseDTO(students);
	}


	@Override
	public StudentResponseDTO getStudentById(long id) {
		Student student = studentRepository.findById(id).orElse(null);
		return convertStudentToStudentResponseDTO(student);

		

		
	}


	private List<StudentResponseDTO> convertStudentToStudentResponseDTO(List<Student> students) {
		  List<StudentResponseDTO> studentsDTO = new ArrayList<>();
		    for (Student s : students) {
		        StudentResponseDTO studentDTO = new StudentResponseDTO();
		        studentDTO.setId(s.getId());
		        studentDTO.setStudentName(s.getName());
		        
		        List<CourseResponseDTO> courses = new ArrayList<>();
		        for (Course c : s.getCourses()) {
		            CourseResponseDTO courseResponseDTO = new CourseResponseDTO();
		            courseResponseDTO.setId(c.getId());
		            courseResponseDTO.setTitle(c.getTitle());
		            courses.add(courseResponseDTO);
		        }
		        studentDTO.setCourses(courses);;
		        studentsDTO.add(studentDTO);
		        
		    }
		    return studentsDTO;
		}

	


	@Override
	public String deleteStudentById(long id) {
		Student student = studentRepository.findById(id).orElse(null);
		if(student==null) {
			return "No Student Found";
		}
		studentRepository.delete(student);
		return "Deleted Succesfully";

	}


	@Override
	public CourseResponseDTO addCourse(@Valid Course course) {
		return convertCourseToCourseDTO(courseRepository.save(course));

	}


	private CourseResponseDTO convertCourseToCourseDTO(Course course) {
		CourseResponseDTO courseResponseDTO=new CourseResponseDTO();
		courseResponseDTO.setId(course.getId());
		courseResponseDTO.setTitle(course.getTitle());
		List<StudentResponseDTO> students=new ArrayList<StudentResponseDTO>();
		for(Student s:course.getStudents()) {
			StudentResponseDTO studentResponseDTO=new StudentResponseDTO();
			studentResponseDTO.setId(s.getId());
			studentResponseDTO.setStudentName(s.getName());
			students.add(studentResponseDTO);
		}
		courseResponseDTO.setStudents(students);
		return courseResponseDTO;
	

	}


	@Override
	public List<CourseResponseDTO> getCourses() {
		List<Course> courses = courseRepository.findAll();
		return convertCoursesToCourseResponseDTO(courses);
	}



	private List<CourseResponseDTO> convertCoursesToCourseResponseDTO(List<Course> courses) {
		List<CourseResponseDTO> coursesDTO=new ArrayList<CourseResponseDTO>();
		for(Course c:courses) {
			CourseResponseDTO courseResponseDTO=new CourseResponseDTO();
			courseResponseDTO.setId(c.getId());
			courseResponseDTO.setTitle(c.getTitle());
			List<StudentResponseDTO> students=new ArrayList<StudentResponseDTO>();
			for(Student s:c.getStudents()) {
				StudentResponseDTO studentResponseDTO=new StudentResponseDTO();
				studentResponseDTO.setId(s.getId());
				studentResponseDTO.setStudentName(s.getName());
				students.add(studentResponseDTO);
			}
			courseResponseDTO.setStudents(students);
			coursesDTO.add(courseResponseDTO);
		}
		return coursesDTO;
	}

	


	@Override
	public CourseResponseDTO geCourseById(long id) {
		Course course = courseRepository.findById(id).orElse(null);
		if(course==null) {
			return null;
		}
		return convertCourseToCourseDTO(course);
	}


	@Override
	public String  deleteCourseById(long id) {
		Course course = courseRepository.findById(id).orElse(null);
		if(course==null) {
			return "No Student Found";
		}
		courseRepository.delete(course);
		return "Deleted Succesfully";
	}

	@Override
	 public StudentResponseDTO addCourseToStudent(long studentId, long courseId) {
        Student student = studentRepository.findById(studentId).orElse(null);
        if (student != null) {
            Course course = courseRepository.findById(courseId).orElse(null);
            if (course != null) {
                student.addCourse(course);
                studentRepository.save(student);
                return convertStudentToStudentResponseDTO(student);
            }
        }
        return null;
    }


	
	
		



	@Override
	public StudentResponseDTO deleteCourseToStudent(long studentId, long courseId) {
		
		 Student student = studentRepository.findById(studentId).orElse(null);
	        if (student != null) {
	            Course course = courseRepository.findById(courseId).orElse(null);
	            if (course != null) {
	                student.removeCourse(course);
	                studentRepository.save(student);
	                return convertStudentToStudentResponseDTO(student);
	            }
	        }
	        return null;
	    }


	
}